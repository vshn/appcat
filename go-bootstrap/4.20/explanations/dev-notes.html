<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns/website#">
  <head itemscope itemtype="http://schema.org/WebSite">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Dev Notes for Composition Functions :: Application Catalog</title>
    <meta property="og:title" itemprop="name" content="Dev Notes for Composition Functions">
    <meta name="twitter:title" content="Dev Notes for Composition Functions">
    <link rel="canonical" href="https://vshn.github.io/appcat/go-bootstrap/explanations/dev-notes.html">
    <meta property="og:url" content="https://vshn.github.io/appcat/go-bootstrap/explanations/dev-notes.html">
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Application Catalog" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="vshn_ch">
    <meta property="og:locale" content="en_US" />
    <script>var uiRootPath = '../../../_'</script>
    <script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/7105834.js"></script>
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon" sizes="152x152" href="/_/img/favicon-152x152.png">
<link rel="apple-touch-icon" sizes="167x167" href="/_/img/favicon-167x167.png">
<link rel="apple-touch-icon" sizes="180x180" href="/_/img/favicon-180x180.png">

<link rel="icon" type="image/png" href="/_/img/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/_/img/favicon-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/_/img/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/_/img/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/_/img/favicon-32x32.png" sizes="32x32">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <div class="vshn_logo"></div>
        <a href="https://vshn.github.io/appcat">Application Catalog
           â€“
          v4.20</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">VSHN</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" target="_blank" href="https://www.vshn.ch/">Main website</a>
            <a class="navbar-item" target="_blank" href="https://handbook.vshn.ch/">Handbook</a>
            <a class="navbar-item" target="_blank" href="https://kb.vshn.ch/">Knowledge Base</a>
            <a class="navbar-item" target="_blank" href="https://products.docs.vshn.ch/">Products</a>
            <a class="navbar-item" target="_blank" href="https://legal.docs.vshn.ch/">Legal</a>
            <a class="navbar-item" target="_blank" href="https://control.docs.vshn.ch/">Portal Help</a>
            <a class="navbar-item" target="_blank" href="https://docs.appuio.cloud/">APPUiO Cloud Docs</a>
            <a class="navbar-item" target="_blank" href="https://syn.tools/">Project Syn</a>
            <a class="navbar-item" target="_blank" href="https://k8up.io/">K8up</a>
          </div>
        </div>
        <div class="navbar-item">
          <div class="search-field">
            <input id="search-input" class="search-input" type="search" placeholder="Search">
            <button type="submit" class="search-button">
              <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="go-bootstrap" data-version="4.20">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Go Bootstrap</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://github.com/vshn/go-bootstrap/releases" target="_blank" rel="noopener">Changelog</a> ðŸ”—</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">How To</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#how-tos/vscode.adoc">how-tos/vscode.adoc</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Technical reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../references/apiserver/env-variables.html">Env variables</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Explanation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="apiserver/boostrap.html">Boostrap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="comp-functions/runtime.html">Runtime Library</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="comp-functions/vshn-postgres.html">VSHN Postgres Functions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="slareports.html">SLA Reports</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="dev-notes.html">Dev Notes for Composition Functions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="comp-functions/debug.html">Debugging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="comp-functions/redis-pvc-resize.html">Redis PVC resize</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Go Bootstrap</span>
    <span class="version">4.20</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../appcat/index.html">Application Catalog</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../appcat/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../index.html">Go Bootstrap</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../index.html">master</a>
        </li>
        <li class="version">
          <a href="../../4.22/index.html">4.22</a>
        </li>
        <li class="version">
          <a href="../../4.21/index.html">4.21</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">4.20</a>
        </li>
        <li class="version">
          <a href="../../4.19/index.html">4.19</a>
        </li>
        <li class="version">
          <a href="../../4.18/index.html">4.18</a>
        </li>
        <li class="version">
          <a href="../../4.17/index.html">4.17</a>
        </li>
        <li class="version">
          <a href="../../4.16/index.html">4.16</a>
        </li>
        <li class="version">
          <a href="../../4.15/index.html">4.15</a>
        </li>
        <li class="version">
          <a href="../../4.14/index.html">4.14</a>
        </li>
        <li class="version">
          <a href="../../4.13/index.html">4.13</a>
        </li>
        <li class="version">
          <a href="../../4.12/index.html">4.12</a>
        </li>
        <li class="version">
          <a href="../../4.11/index.html">4.11</a>
        </li>
        <li class="version">
          <a href="../../4.10/index.html">4.10</a>
        </li>
        <li class="version">
          <a href="../../4.9/index.html">4.9</a>
        </li>
        <li class="version">
          <a href="../../4.8/index.html">4.8</a>
        </li>
        <li class="version">
          <a href="../../4.7/index.html">4.7</a>
        </li>
        <li class="version">
          <a href="../../4.6/index.html">4.6</a>
        </li>
        <li class="version">
          <a href="../../4.5/index.html">4.5</a>
        </li>
        <li class="version">
          <a href="../../4.4/index.html">4.4</a>
        </li>
        <li class="version">
          <a href="../../4.3/index.html">4.3</a>
        </li>
        <li class="version">
          <a href="../../4.2/index.html">4.2</a>
        </li>
        <li class="version">
          <a href="../../4.1/index.html">4.1</a>
        </li>
        <li class="version">
          <a href="../../4.0/index.html">4.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../appcat/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Go Bootstrap</a></li>
    <li>Explanation</li>
    <li><a href="dev-notes.html">Dev Notes for Composition Functions</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">4.20</button>
  <div class="version-menu">
    <a class="version" href="../../explanations/dev-notes.html">master</a>
    <a class="version" href="../../4.22/explanations/dev-notes.html">4.22</a>
    <a class="version" href="../../4.21/explanations/dev-notes.html">4.21</a>
    <a class="version is-current" href="dev-notes.html">4.20</a>
    <a class="version" href="../../4.19/explanations/dev-notes.html">4.19</a>
    <a class="version" href="../../4.18/explanations/dev-notes.html">4.18</a>
    <a class="version" href="../../4.17/explanations/dev-notes.html">4.17</a>
    <a class="version" href="../../4.16/explanations/dev-notes.html">4.16</a>
    <a class="version" href="../../4.15/explanations/dev-notes.html">4.15</a>
    <a class="version" href="../../4.14/explanations/dev-notes.html">4.14</a>
    <a class="version" href="../../4.13/explanations/dev-notes.html">4.13</a>
    <a class="version" href="../../4.12/explanations/dev-notes.html">4.12</a>
    <a class="version" href="../../4.11/explanations/dev-notes.html">4.11</a>
    <a class="version is-missing" href="../../4.10/index.html">4.10</a>
    <a class="version is-missing" href="../../4.9/index.html">4.9</a>
    <a class="version is-missing" href="../../4.8/index.html">4.8</a>
    <a class="version is-missing" href="../../4.7/index.html">4.7</a>
    <a class="version is-missing" href="../../4.6/index.html">4.6</a>
    <a class="version is-missing" href="../../4.5/index.html">4.5</a>
    <a class="version is-missing" href="../../4.4/index.html">4.4</a>
    <a class="version is-missing" href="../../4.3/index.html">4.3</a>
    <a class="version is-missing" href="../../4.2/index.html">4.2</a>
    <a class="version is-missing" href="../../4.1/index.html">4.1</a>
    <a class="version is-missing" href="../../4.0/index.html">4.0</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/vshn/appcat/edit/docs/v4.20/docs/modules/ROOT/pages/explanations/dev-notes.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Dev Notes for Composition Functions</h1>
<div class="sect1">
<h2 id="_read_from_desired_vs_observed"><a class="anchor" href="#_read_from_desired_vs_observed"></a>Read from Desired vs Observed</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It may not be easy to determine when to read from the desired or observed resources in the composition function.</p>
</div>
<div class="paragraph">
<p>On the very first run of the composition functions, the observe array will always be empty.
To ensure that you always get a valid object in that case, you can first try to read from observed, and if that fails, read from desired.</p>
</div>
<div class="sect2">
<h3 id="_desired"><a class="anchor" href="#_desired"></a>Desired</h3>
<div class="paragraph">
<p>Contains the list of resource that will be applied after the function has run.
They are the sum of the P+T composition and the composition functions.</p>
</div>
<div class="paragraph">
<p>Read from this if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you manipulate the same resources as a previous step, otherwise you could overwrite resources</p>
</li>
<li>
<p>you don&#8217;t need to know how the resource currently looks like but how it should look like after the function has run</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_observed"><a class="anchor" href="#_observed"></a>Observed</h3>
<div class="paragraph">
<p>The observed array contains resources as they are on the cluster right before the composition function triggered.</p>
</div>
<div class="paragraph">
<p>Read from this if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you need access to the status</p>
</li>
<li>
<p>you want to read secrets</p>
</li>
<li>
<p>an outside actor changes values of the resource (for example maintenance jobs)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_read_unmanaged_secrets"><a class="anchor" href="#_how_to_read_unmanaged_secrets"></a>How to read unmanaged secrets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are cases where you need to read a secret that was created by an operator or helm chart, for example to add them to the connection details.</p>
</div>
<div class="paragraph">
<p>To read unmanaged secrets, you need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create an observe kube object that references the given secret</p>
</li>
<li>
<p>then get the secret through this observe kube object during the next reconcile</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When doing it this way the secret values are available in plaintext and NOT in base64.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_not_delete_resources_in_the_composition_function"><a class="anchor" href="#_how_to_not_delete_resources_in_the_composition_function"></a>How to (not) delete resources in the composition function</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For crossplane, if a given resource was in the desired array during the previous reconcile, but is missing in the current reconcile, then it will be removed.
If, for any reason, the resource name in the functionIO changes, even though it&#8217;s still the same object, crossplane will delete and re-create it.
That&#8217;s because for crossplane it&#8217;s a new object in that case, as it uses the resource name to identify the resources.
The resource name of important resources (releases, deployments, pvcs, etc.) should never change, or expect unhappy users.</p>
</div>
<div class="paragraph">
<p>If an object should not get deleted, then it has to be actively be added to the desired array on every reconcile.
On the flip side, deleting an object is easily achieved by not adding it to the desired array.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_when_to_use_composition_functions_jobs_and_cronjobs"><a class="anchor" href="#_when_to_use_composition_functions_jobs_and_cronjobs"></a>When to use Composition functions, jobs and cronjobs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The general rule is to keep the composition functions as simple as possible.
They should be used mainly to create and observe objects related to the instances.</p>
</div>
<div class="paragraph">
<p>If there&#8217;s a need for more complex one time operations, please consider putting them into a separate job that is deployed via the composition function.
Example for such a job is the restore of a backup.</p>
</div>
<div class="paragraph">
<p>If there&#8217;s a need for more complex operations on a schedule, please consider putting them into a cronjob that is deployed via the composition function.
Examples for such cronjobs are maintenance and backups.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright Â© VSHN 2021 â€“ All Rights Reserved. <a href="https://vshn.ch/en/privacy-policy/">Privacy Policy</a>, <a href="https://vshn.ch/en/imprint/">Imprint</a>, and <a href="https://vshn.ch/en/contact/">Contact</a>.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
  </body>
</html>
